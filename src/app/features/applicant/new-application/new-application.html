<app-modal
  [isOpen]="isOpen"
  [size]="'lg'"
  [showFooter]="false"
  title="New Road Reclassification Application"
  (closeModal)="cancel()"
>
  <div modal-body>
    <div class="form-container">
      <!-- Progress Stepper -->
      <div class="progress-section">
        <div class="stepper-container">
          <div
            *ngFor="let step of [1, 2, 3, 4, 5, 6]"
            class="stepper-item"
            [class.completed]="isStepCompleted(step)"
            [class.active]="currentStep === step"
            (click)="goToStep(step)"
          >
            <div class="stepper-number">
              <span *ngIf="!isStepCompleted(step)">{{ step }}</span>
              <svg *ngIf="isStepCompleted(step)" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </div>
            <div class="stepper-content">
              <span class="stepper-label">{{ getStepTitle(step) }}</span>
            </div>
          </div>
        </div>

        <div class="progress-info">
          <span class="step-text">Step {{ currentStep }} of {{ totalSteps }}</span>
          <span class="progress-percentage">{{ getProgressPercentage() }}%</span>
        </div>
      </div>

      <!-- Form Content -->
      <form [formGroup]="applicationForm" class="application-form">

        <!-- Step 1: Road Selection -->
        <div *ngIf="currentStep === 1" class="form-step">
          <div class="step-header">
            <h2>Road Selection</h2>
            <p>Select the road and applicant type</p>
          </div>

          <div class="form-grid">
            <!-- Applicant Type -->
            <app-form-select
              label="Applicant Type"
              [options]="applicantTypeOptions"
              formControlName="applicantType"
              [required]="true"
            ></app-form-select>

            <!-- Road Selection Dropdown -->
            <div class="form-field">
              <label>Select Road <span class="required">*</span></label>
              <div class="select-wrapper" [class.loading]="isLoadingRoads" [class.error]="roadsLoadError">
                <select
                  [disabled]="isLoadingRoads"
                  (change)="onRoadSelect($event)"
                  [value]="selectedRoad?.id || ''"
                >
                  <option value="">{{ isLoadingRoads ? 'Loading roads...' : 'Select a road' }}</option>
                  <option *ngFor="let road of roads" [value]="road.id">
                    {{ road.name }} {{ road.roadNumber ? '(' + road.roadNumber + ')' : '' }} - {{ road.region || 'N/A' }}
                  </option>
                </select>
                <svg class="select-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
              </div>
              <span class="error-message" *ngIf="roadsLoadError">{{ roadsLoadError }} <a (click)="loadRoads()">Retry</a></span>
            </div>

            <!-- Auto-filled from selected road -->
            <ng-container *ngIf="selectedRoad">
              <app-form-input
                label="Starting Point"
                formControlName="startingPoint"
                placeholder="Enter starting point"
                [required]="true"
              ></app-form-input>

              <app-form-input
                label="Terminal Point"
                formControlName="terminalPoint"
                placeholder="Enter terminal point"
                [required]="true"
              ></app-form-input>

              <app-form-input
                label="Road Length (km)"
                type="number"
                formControlName="roadLength"
                placeholder="0.0"
                [min]="0"
                [step]="0.1"
                [required]="true"
              ></app-form-input>
            </ng-container>
          </div>
        </div>

        <!-- Step 2: Classification -->
        <div *ngIf="currentStep === 2" class="form-step">
          <div class="step-header">
            <h2>Classification Details</h2>
            <p>Specify current and proposed road classification</p>
          </div>

          <div class="form-grid">
            <app-form-select
              label="Current Classification"
              placeholder="Select current classification"
              [options]="roadClassOptions"
              formControlName="currentClass"
              [required]="true"
            ></app-form-select>

            <app-form-select
              label="Proposed Classification"
              placeholder="Select proposed classification"
              [options]="roadClassOptions"
              formControlName="proposedClass"
              [required]="true"
            ></app-form-select>

            <!-- Classification Change Preview -->
            <div class="form-group full-width" *ngIf="applicationForm.get('currentClass')?.value && applicationForm.get('proposedClass')?.value">
              <div class="classification-preview">
                <div class="preview-item current">
                  <span class="label">Current</span>
                  <span class="value">{{ roadClassLabels[applicationForm.get('currentClass')?.value] }}</span>
                </div>
                <div class="preview-arrow">â†’</div>
                <div class="preview-item proposed">
                  <span class="label">Proposed</span>
                  <span class="value">{{ roadClassLabels[applicationForm.get('proposedClass')?.value] }}</span>
                </div>
              </div>
            </div>

            <div class="full-width">
              <app-form-textarea
                label="Justification"
                formControlName="reclassificationReasons"
                placeholder="Explain why this road should be reclassified..."
                [rows]="4"
                [required]="true"
                [minLength]="50"
                [showCharCount]="true"
                [hasError]="!!(applicationForm.get('reclassificationReasons')?.invalid && applicationForm.get('reclassificationReasons')?.touched)"
                errorMessage="Minimum 50 characters required"
              ></app-form-textarea>
            </div>
          </div>
        </div>

        <!-- Step 3: Road Characteristics -->
        <div *ngIf="currentStep === 3" class="form-step">
          <div class="step-header">
            <h2>Road Characteristics</h2>
            <p>Provide road surface and dimension details</p>
          </div>

          <div class="form-grid">
            <app-form-select
              label="Carriageway Surface Type"
              placeholder="Select surface type"
              [options]="surfaceTypeOptions"
              formControlName="surfaceTypeCarriageway"
              [required]="true"
            ></app-form-select>

            <app-form-select
              label="Shoulders Surface Type"
              placeholder="Select surface type (optional)"
              [options]="surfaceTypeOptions"
              formControlName="surfaceTypeShoulders"
            ></app-form-select>

            <app-form-input
              label="Carriageway Width"
              type="number"
              formControlName="carriagewayWidth"
              placeholder="7.0"
              suffix="meters"
              helpText="Paved road surface width"
              [min]="1"
              [step]="0.1"
              [required]="true"
            ></app-form-input>

            <app-form-input
              label="Formation Width"
              type="number"
              formControlName="formationWidth"
              placeholder="10.0"
              suffix="meters"
              helpText="Including shoulders"
              [min]="1"
              [step]="0.1"
              [required]="true"
            ></app-form-input>

            <app-form-input
              label="Road Reserve Width"
              type="number"
              formControlName="actualRoadReserveWidth"
              placeholder="30.0"
              suffix="meters"
              helpText="Gazetted reserve width"
              [min]="1"
              [step]="0.1"
              [required]="true"
            ></app-form-input>
          </div>
        </div>

        <!-- Step 4: Traffic & Connectivity -->
        <div *ngIf="currentStep === 4" class="form-step">
          <div class="step-header">
            <h2>Traffic & Connectivity</h2>
            <p>Describe traffic and connectivity details</p>
          </div>

          <div class="form-grid">
            <app-form-select
              label="Traffic Level"
              placeholder="Select traffic level"
              [options]="trafficLevelOptions"
              formControlName="trafficLevel"
              [required]="true"
            ></app-form-select>

            <app-form-input
              label="Traffic Composition"
              formControlName="trafficComposition"
              placeholder="e.g., 60% light vehicles, 30% trucks..."
              [required]="true"
            ></app-form-input>

            <div class="full-width">
              <app-form-textarea
                label="Towns/Villages Linked"
                formControlName="townsVillagesLinked"
                placeholder="List towns and villages connected by this road..."
                [rows]="2"
                [required]="true"
              ></app-form-textarea>
            </div>

            <div class="full-width">
              <app-form-textarea
                label="Principal Nodes"
                formControlName="principalNodes"
                placeholder="Major junctions, terminals, markets (optional)"
                [rows]="2"
              ></app-form-textarea>
            </div>

            <div class="full-width">
              <app-form-textarea
                label="Bus Routes"
                formControlName="busRoutes"
                placeholder="Public transport routes using this road..."
                [rows]="2"
                [required]="true"
              ></app-form-textarea>
            </div>

            <div class="full-width">
              <app-form-textarea
                label="Public Services"
                formControlName="publicServices"
                placeholder="Schools, hospitals, government offices along the road..."
                [rows]="2"
                [required]="true"
              ></app-form-textarea>
            </div>

            <div class="full-width">
              <app-form-textarea
                label="Alternative Routes"
                formControlName="alternativeRoutes"
                placeholder="Other routes that could serve similar destinations (optional)"
                [rows]="2"
              ></app-form-textarea>
            </div>
          </div>
        </div>

        <!-- Step 5: Eligibility Criteria -->
        <div *ngIf="currentStep === 5" class="form-step">
          <div class="step-header">
            <h2>Eligibility Criteria for {{ applicationForm.get('proposedClass')?.value === 'TRUNK' ? 'Trunk' : 'Regional' }} Road</h2>
            <p>Select at least one criterion that applies to this road</p>
          </div>

          <!-- Show message if no proposed class selected -->
          <div *ngIf="eligibilityCriteria.length === 0" class="criteria-status warning">
            <span>Please select a proposed classification in Step 2 to see eligibility criteria</span>
          </div>

          <div class="criteria-list" *ngIf="eligibilityCriteria.length > 0">
            <div
              *ngFor="let criterion of eligibilityCriteria; let i = index"
              class="criterion-item"
              [class.selected]="criterion.selected"
              (click)="toggleCriterion(i)"
            >
              <div class="criterion-checkbox">
                <svg *ngIf="criterion.selected" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
              </div>
              <div class="criterion-content">
                <span class="criterion-code">{{ criterion.code }}</span>
                <span class="criterion-text">{{ criterion.description }}</span>
              </div>
            </div>
          </div>

          <div class="criteria-status" *ngIf="eligibilityCriteria.length > 0" [class.valid]="getSelectedCriteria().length > 0">
            <span *ngIf="getSelectedCriteria().length > 0">{{ getSelectedCriteria().length }} criteria selected</span>
            <span *ngIf="getSelectedCriteria().length === 0" class="warning">Please select at least one criterion</span>
          </div>
        </div>

        <!-- Step 6: Documents -->
        <div *ngIf="currentStep === 6" class="form-step">
          <div class="step-header">
            <h2>Supporting Documents</h2>
            <p>Upload supporting documents for your application (optional)</p>
          </div>

          <div class="upload-section">
            <label for="file-upload" class="upload-area">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <h3>Click to upload or drag and drop</h3>
              <p>PDF, DOC, DOCX, JPG, PNG (max 10MB per file)</p>
              <input
                type="file"
                id="file-upload"
                multiple
                accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                (change)="onFileSelect($event)"
              />
            </label>

            <div class="uploaded-files" *ngIf="uploadedDocuments.length > 0">
              <h4>Uploaded Documents ({{ uploadedDocuments.length }})</h4>
              <div class="file-list">
                <div *ngFor="let doc of uploadedDocuments; let i = index" class="file-item">
                  <div class="file-icon" [ngClass]="getFileIcon(doc.type)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14 2 14 8 20 8"/>
                    </svg>
                  </div>
                  <div class="file-info">
                    <span class="file-name">{{ doc.name }}</span>
                    <span class="file-size">{{ formatFileSize(doc.size) }}</span>
                  </div>
                  <button type="button" class="btn-remove" (click)="removeDocument(i)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <div class="document-suggestions" *ngIf="uploadedDocuments.length === 0">
              <p><strong>Suggested documents:</strong></p>
              <ul>
                <li>Traffic count survey report</li>
                <li>Road condition assessment</li>
                <li>Location map / GPS coordinates</li>
                <li>Photos of the road</li>
                <li>Letters of support from local authorities</li>
              </ul>
            </div>
          </div>
        </div>
      </form>

      <!-- Form Actions -->
      <div class="form-actions">
        <app-button variant="ghost" (clicked)="cancel()">Cancel</app-button>
        <div class="action-buttons">
          <app-button
            variant="secondary"
            *ngIf="currentStep > 1"
            (clicked)="previousStep()"
          >Previous</app-button>
          <app-button
            variant="primary"
            *ngIf="currentStep < totalSteps"
            (clicked)="nextStep()"
          >Next</app-button>
          <app-button
            variant="primary"
            *ngIf="currentStep === totalSteps"
            (clicked)="submitApplication()"
            [disabled]="!isFormComplete()"
            [loading]="isSubmitting"
            loadingText="Saving..."
          >Save as Draft</app-button>
        </div>
      </div>
    </div>
  </div>
</app-modal>
